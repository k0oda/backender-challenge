# Решение для проблемы синхронного логирования в ClickHouse

Документация по техническому решению, реализованному для устранения проблем, связанных с логированием event-логов в ClickHouse

## Проблемы

- Из-за отсутствия транзакционности логи терялись в случае смерти веб-воркера между завершением выполнения бизнес-логики и записью в CH
- Ошибки записи в сети Clickhouse приводили к плохому UX
- Clickhouse страдал от большого количества мелких вставок

## Решение

### Добавление Transactional Outbox pattern

- Новая модель `EventOutbox` была добавлена ​​для хранения event-ов перед отправкой в ClickHouse

### Механизм обработки

- События сначала сохраняются в `EventOutbox` в рамках транзакции вместе с основной бизнес-логикой
- Отдельный воркер Celery периодически забирает события из `EventOutbox`, агрегирует их и записывает в ClickHouse партиями по 100 элементов каждая
- Пакетирование уменьшает количество вставок в ClickHouse, что работает лучше, чем множество мелких вставок, а так же повышает производительность и стабильность
- Задача Outbox отделена от основной логики обработки event-ов

### Обработка пакетов

- Celery Beat используется для настройки периодичности задачи, которая отправляет данные в ClickHouse

### Обработка ошибок

- Повторные попытки отправки event-ов (с использованием механизма `retry`) в случае ошибок
- Регистрация ошибок с помощью `structlog`

### Модульные тесты

- Удален тест `test_event_log_entry_published` из-за изменения поведения `EventLogClient.insert`
- Реализован тест `test_event_inserted_to_outbox`
- Реализован тест `test_event_outbox_processed`

## Изменения в поведении `EventLogClient.insert`

Теперь `EventLogClient.insert` не вызывает функцию `EventLogClient._convert_data` для преобразования данных, поскольку теперь она должна вызываться задачей `process_outbox_events`, которая собирает обьекты модели `EventOutbox` с уже преобразованными данными

## Другие мелкие исправления

В `core.settings` в строке 72 параметр `CLICKHOUSE_PORT` использовал переменную среды `CLICKHOUSE_HOST` вместо `CLICKHOUSE_PORT`

## Установка

Поместите файл `.env` в каталог `src/core`:

```
cp src/core/.env.ci src/core/.env
```

Запустите контейнеры:
```
make run
```

а затем запустите скрипт установки с помощью:

```
make install
```

## Тесты

`make test`

## Linter

`make lint`